---
layout: page
title: mTLS
permalink: "/mtls/"
---

# Aranya mTLS Authentication

## Overview

mTLS is mutual TLS authentication. Traditional TLS only authenticates the server to the client, but not the client to the server. mTLS provides mutual authentication by validating the identities of both peers to each other via their TLS certs before sending data over a secure channel.

mTLS authentication in the Aranya syncer allows users to leverage their existing PKI infrastructure to authenticate nodes to each other before syncing.

Aranya's sync traffic is currently secured via `s2n_quic` PSKs. We developed our own fork of `s2n_quic` to add support for PSKs to the library. While PSKs are the ideal solution for securing QUIC communications for our zero-trust application, there are a few realities that make it impractical:
- Upstreaming our PSK branch to the `main` branch of `s2n_quic` is not going to happen any time soon.
- There is better support for TLS certs in the broader security and networking community as well as the QUIC libraries available in Rust.

Because of this, we plan to migrate the authentication/encryption of the Aranya syncer transport from QUIC PSKs to QUIC mTLS certs.

Abbreviations in this document:
- certificate -> cert
- certificates -> certs

## Certificate Generation

mTLS certs are generated externally via a user's existing PKI infrastructure.
An example CA that generates root and device certs will be provided for users that do not have an existing PKI infrastructure.

We recommend using ECDH certs generated from a secret key of at least 224 bits.

The PKI infrastructure should use a root cert to sign an Aranya device cert before adding the device to the team. Root certs and device certs will be configured during team onboarding.

## mTLS APIs

- `SetRootCerts(root_certs)` - sets the root certs to be used by the current device. These root certs should be generated by the external PKI infrastructure.
- `SetCert(cert)` - sets the current device's cert. This cert must be signed by an external root cert provided by the PKI infrastructure or authentication will fail.
- `RemoveTeam(team_id)` - removes all root and device certs for that team.

All PSK and IKM related APIs and configs for the QUIC syncer will be replaced with the new cert APIs defined in this document.

## Persistent Certificate Storage

mTLS certs will be stored in a persistent location such as a cert directory on disk.

The filename of each cert will be the hash of the cert so there are no naming collisions.

Certs will be stored in a subdirectory based on the team ID so that certs can be tracked independently for each team.

Example cert path:
<daemon_working_directory>/certs/<team_id>/<cert_hash>

Storing the certs in a directory on disk is flexible since certs can be manually added/removed by an operator or automatically by making relevant API calls which update the certs.

The aranya daemon should periodically (e.g. once a second) check the cert directory for any changes so it can update the certs in-use by the QUIC transport implementation. Generally, the daemon would already know if there are any changes because it would process an API call to add/remove a cert. The reason for checking the directory periodically is to handle the case where an operator manually added/removed a cert from the directory.

## Example

TODO
